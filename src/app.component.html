<!-- Container principal da galeria com listeners para interação -->
<div
  class="app-shell"
  [class.is-mobile]="isMobileLayout()"
  [class.is-idle]="isIdle() || isAutoNavigationActive()"
  [class.is-fullscreen]="isFullscreen()"
  [attr.aria-busy]="isAppLoading()"
  (contextmenu)="onRightClick($event)">

  <div class="app-shell__viewport">
    @if (isAppLoading()) {
      <div class="app-loading" role="status" aria-live="polite">
        <div class="app-loading__content">
          <div class="kinetic-loader" aria-hidden="true">
            <span></span>
            <span></span>
            <span></span>
            <span></span>
          </div>
          <p class="app-loading__message">{{ appLoadingMessage() }}</p>
        </div>
      </div>
    }
    <ng-template #userMenu>
      @if (isAuthenticated()) {
        <div class="user-menu">
          <button
            type="button"
            data-cursor-pointer
            class="user-menu__trigger"
            aria-label="Menu do perfil"
            [attr.aria-expanded]="isUserMenuOpen()"
            (click)="toggleUserMenu($event)">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon--md" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 20.25a8.25 8.25 0 0 1 15 0" />
            </svg>
          </button>

          @if (isUserMenuOpen()) {
            <div
              class="user-menu__dropdown"
              (mouseenter)="pauseCanvasNavigation()"
              (mouseleave)="resumeCanvasNavigation()"
              (focusin)="pauseCanvasNavigation()"
              (focusout)="resumeCanvasNavigation($event)">
              <div class="user-menu__header">
                <div class="user-menu__avatar">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon icon--sm" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 20.25a8.25 8.25 0 0 1 15 0" />
                  </svg>
                </div>
                <div class="user-menu__details">
                  <span class="user-menu__email" [title]="authUserEmail() ?? undefined">{{ authUserEmail() }}</span>
                  <span class="user-menu__role">Sessão ativa • {{ userRoleLabel() }}</span>
                </div>
              </div>

              <div class="user-menu__actions">
                <button
                  type="button"
                  class="button button--ghost user-menu__action user-menu__action--subtle"
                  data-cursor-pointer
                  (click)="refreshApp()">
                  Atualizar app
                </button>
                <button
                  type="button"
                  class="button button--ghost user-menu__action"
                  data-cursor-pointer
                  (click)="openSettingsDialog()">
                  Preferências
                </button>
                <button
                  type="button"
                  class="button button--ghost user-menu__action"
                  data-cursor-pointer
                  (click)="signOut()">
                  Sair da conta
                </button>
              </div>
            </div>
          }
        </div>
      }
    </ng-template>

    @if (!isMobileLayout()) {
      <div
        class="app-shell__status-bar"
        (mouseenter)="pauseCanvasNavigation()"
        (mouseleave)="resumeCanvasNavigation()"
        (focusin)="pauseCanvasNavigation()"
        (focusout)="resumeCanvasNavigation($event)">
        @if (!isAuthenticated()) {
          <div class="app-shell__auth-actions">
            <button
              type="button"
              class="button button--ghost app-shell__auth-button"
              data-cursor-pointer
              (click)="openLoginDialog()">
              Entrar
            </button>
            <button
              type="button"
              class="button button--ghost app-shell__auth-button"
              data-cursor-pointer
              (click)="openSignUpDialog()">
              Criar conta
            </button>
          </div>
        }
        @if (canAccessUserGalleryActions()) {
          <button
            type="button"
            class="button button--primary app-shell__auth-button app-shell__gallery-button"
            data-cursor-pointer
            (click)="onUserGalleryAction()">
            @if (hasUserGallery()) {
              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon--sm" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 4.5 4.5 12l6.75 7.5" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 12h13.5" />
              </svg>
            } @else {
              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon--sm" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m6-6H6" />
              </svg>
            }
            {{ userGalleryActionLabel() }}
          </button>
        }
        <ng-container [ngTemplateOutlet]="userMenu"></ng-container>
      </div>
    } @else if (mobileView() === 'capture') {
      @if (isAuthenticated()) {
        <div
          class="app-shell__status-bar app-shell__status-bar--mobile"
          (mouseenter)="pauseCanvasNavigation()"
          (mouseleave)="resumeCanvasNavigation()"
          (focusin)="pauseCanvasNavigation()"
          (focusout)="resumeCanvasNavigation($event)">
          <div class="app-shell__auth-actions">
            <ng-container [ngTemplateOutlet]="userMenu"></ng-container>
          </div>
        </div>
      }
    }

    <ng-template #captureGallerySelection let-captureComponent="captureComponent">
    @if (isMobileLayout()) {
      @if (canViewMobileGalleryList()) {
        @if (galleries().length === 0) {
          <div class="stack stack--tight">
            <div class="mobile-card mobile-card--locked">
              <div class="mobile-card__content">
                <div class="mobile-card__heading">
                  <h3 class="mobile-card__title">Nenhuma galeria disponível</h3>
                </div>
                <p class="mobile-card__description">
                  Acesse a lista de galerias para visualizar ou criar novas.
                </p>
              </div>
            </div>
            @if (canCreateGalleries()) {
              <button
                type="button"
                class="mobile-card mobile-card--action"
                (click)="openGalleryCreationDialogForMobileCapture()"
                data-cursor-pointer>
                <div class="mobile-card__media">
                  <div class="mobile-card__placeholder">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke-width="1.5"
                      stroke="currentColor"
                      class="icon icon--md">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                    </svg>
                  </div>
                </div>
                <div class="mobile-card__content">
                  <div class="mobile-card__heading">
                    <h3 class="mobile-card__title">Criar minha galeria</h3>
                  </div>
                  <p class="mobile-card__description">
                    Abra sua primeira galeria para salvar as capturas do app.
                  </p>
                </div>
              </button>
            }
          </div>
        } @else if (mobileCaptureGallery()) {
          <div class="stack stack--tight">
            <app-mobile-gallery-card
              [gallery]="mobileCaptureGallery()!"
              [coverUrl]="getGalleryCover(mobileCaptureGallery()!)"
              [active]="true"
              [showActiveIndicator]="true"
              [selectable]="canSelectMobileCaptureGallery()"
              (select)="openMobileGalleryPicker(); captureComponent?.requestGallerySelection()"
              (open)="openMobileGalleryDetail(mobileCaptureGallery()!.id)"
            />
          </div>
        } @else {
          <button
            type="button"
            class="mobile-card mobile-card--action"
            (click)="openMobileGalleryPicker(); captureComponent?.requestGallerySelection()"
            data-cursor-pointer>
            <div
              class="mobile-card__media">
              <div class="mobile-card__placeholder">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                  class="icon icon--md">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
              </div>
            </div>
            <div class="mobile-card__content">
              <div class="mobile-card__heading">
                <h3 class="mobile-card__title">Selecionar galeria</h3>
              </div>
              <p class="mobile-card__description">
                Escolha uma galeria para salvar suas capturas.
              </p>
              <div class="mobile-card__meta">
                <span>Sem data</span>
                <span>0 fotos</span>
              </div>
            </div>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="none"
              class="mobile-card__chevron">
              <path
                stroke="currentColor"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M9 5l7 7-7 7" />
            </svg>
          </button>
        }
      } @else if (mobileCaptureGallery()) {
        <div class="stack stack--tight">
          <app-mobile-gallery-card
              [gallery]="mobileCaptureGallery()!"
              [coverUrl]="getGalleryCover(mobileCaptureGallery()!)"
              [active]="true"
              [selectable]="false"
              [showActiveIndicator]="true"
              (open)="openMobileGalleryDetail(mobileCaptureGallery()!.id)"
            />
          </div>
        } @else if (canAccessUserGalleryActions()) {
          <button
            type="button"
            class="mobile-card mobile-card--action"
            (click)="openGalleryCreationDialogForMobileCapture()"
            data-cursor-pointer>
            <div class="mobile-card__media">
              <div class="mobile-card__placeholder">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                  class="icon icon--md">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
              </div>
            </div>
            <div class="mobile-card__content">
              <div class="mobile-card__heading">
                <h3 class="mobile-card__title">Criar minha galeria</h3>
              </div>
              <p class="mobile-card__description">
                Abra sua primeira galeria para salvar as capturas do app.
              </p>
            </div>
          </button>
        } @else {
          <div class="stack stack--tight">
            <button
              type="button"
              class="mobile-card mobile-card--action"
              data-cursor-pointer
              (click)="openSignUpDialog()"
              (pointerdown)="onMobileGallerySelectorPressStart($event)"
              (pointerup)="onMobileGallerySelectorPressEnd()"
              (pointerleave)="onMobileGallerySelectorPressCancel()"
              (pointercancel)="onMobileGallerySelectorPressCancel()">
              <div class="mobile-card__media">
                <div class="mobile-card__placeholder">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                    class="icon icon--md">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.5 19.5a8.25 8.25 0 0115 0M18 9.75h3m-1.5-1.5v3" />
                  </svg>
                </div>
              </div>
              <div class="mobile-card__content">
                <div class="mobile-card__heading">
                  <h3 class="mobile-card__title">Crie sua conta</h3>
                </div>
                <p class="mobile-card__description">
                  Cadastre-se para fotografar.
                </p>
              </div>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                class="mobile-card__chevron">
                <path
                  stroke="currentColor"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="1.5"
                  d="M9 5l7 7-7 7" />
              </svg>
            </button>
            <button
              type="button"
              class="button-reset mobile-card__secondary-action"
              data-cursor-pointer
              (click)="openLoginDialog()">
              Já tenho conta. Entrar
            </button>
          </div>
        }
      } @else {
        <div class="capture-dialog__selection-panel stack stack--tight">
          <div class="capture-dialog__selection-header">
            <p class="capture-dialog__selection-title">Galeria selecionada</p>
            <p class="capture-dialog__selection-hint">Escolha onde salvar a próxima captura.</p>
          </div>

          @if (capturableGalleries().length === 0) {
            <div class="capture-dialog__selection-empty">Nenhuma galeria disponível para captura.</div>
          } @else {
            <label class="capture-dialog__selection-label" for="desktopCaptureGallery">Galeria</label>
              <select
                id="desktopCaptureGallery"
                class="capture-dialog__selection-control"
                [value]="desktopCaptureGalleryId() ?? ''"
                (change)="onDesktopGallerySelect($event, captureComponent)">
              @for (gallery of capturableGalleries(); track gallery.id) {
                <option [value]="gallery.id">{{ gallery.name }}</option>
              }
            </select>

            @if (desktopCaptureGallery()) {
              <p class="capture-dialog__selection-description">Pré-selecionada: {{ desktopCaptureGallery()!.name }}</p>
            }
          }

          @if (canCreateGalleries()) {
            <button
              type="button"
              class="button button--ghost capture-dialog__selection-action"
              (click)="openGalleryCreationDialog(); captureComponent?.requestGallerySelection()">
              Nova galeria
            </button>
          }
        </div>
      }
    </ng-template>

    @if (isMobileLayout()) {
    @switch (mobileView()) {
      @case ('capture') {
        <div class="mobile-shell mobile-shell--capture">
          <div class="mobile-shell__content mobile-shell__content--capture">
            <app-webcam-capture
              #mobileCapture
              class="app-shell__capture full-area"
              [variant]="'mobile'"
              [captureAllowed]="mobileCaptureAllowed()"
              (prepareCapture)="prepareMobileCapture()"
              (capture)="onCaptureComplete($event)">
              <ng-container gallerySelection mobileGallerySelection>
                <ng-container *ngTemplateOutlet="captureGallerySelection; context: { captureComponent: mobileCapture }"></ng-container>
              </ng-container>
            </app-webcam-capture>
          </div>
        </div>
      }
      @case ('galleries') {
        <div class="mobile-shell mobile-shell--galleries">
          <header class="mobile-shell__header">
            <div>
              @if (canViewMobileGalleryList()) {
                <button
                  type="button"
                  class="button button--ghost"
                  (click)="showMobileCapture()">
                  ← Captura
                </button>
              }
            </div>
            <div>
              @if (canViewMobileGalleryList()) {
                <button
                  type="button"
                  class="button button--ghost"
                  (click)="openGalleryCreationDialogForMobileCapture()"
                  title="Apenas administradores podem criar novas galerias"
                >
                  Nova
                </button>
              }
            </div>
          </header>
          <div #mobileScrollContainer class="mobile-shell__content">
            @if (galleries().length === 0) {
              <div class="empty-state empty-state--spaced">
                <svg class="empty-state__icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="0.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
                </svg>
                <h3 class="empty-state__title">Nenhuma galeria ainda</h3>
                @if (canCreateGalleries()) {
                  <p class="empty-state__text">Crie uma galeria para começar a capturar suas memórias.</p>
                } @else {
                  <p class="empty-state__text">Aguarde a publicação de galerias públicas.</p>
                }
              </div>
            } @else {
              <div class="stack stack--loose">
                @for (gallery of galleries(); track gallery.id) {
                  <app-mobile-gallery-card
                    [gallery]="gallery"
                    [coverUrl]="getGalleryCover(gallery)"
                    [active]="mobileCaptureGalleryId() === gallery.id"
                    [selectable]="canViewMobileGalleryList()"
                    (select)="selectMobileCaptureGallery(gallery.id)"
                    (open)="openMobileGalleryDetail(gallery.id)"
                  />
                }
              </div>
            }
          </div>
        </div>
      }
      @case ('galleryDetail') {
        <div class="mobile-shell mobile-shell--detail">
          <header class="mobile-shell__header mobile-shell__header--detail">
            <button
              type="button"
              class="button button--ghost button--icon"
              aria-label="Voltar para galerias"
              (click)="returnToMobileGalleries()">
              <span class="sr-only">Voltar para galerias</span>
              <span class="button__icon" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12l7.5-7.5M3 12h18" />
                </svg>
              </span>
            </button>
            <div class="mobile-shell__actions">
              @if (canManageSelectedGallery()) {
                <button
                  type="button"
                  class="button button--ghost"
                  [disabled]="!activeGallery()"
                  (click)="activeGallery() && useGalleryForCapture(activeGallery()!.id)"
                  title="Disponível apenas para administradores ou proprietários"
                >
                  Usar esta galeria
                </button>
                <button
                  type="button"
                  class="button button--danger button--icon"
                  aria-label="Excluir galeria"
                  [disabled]="!activeGallery()"
                  (click)="deleteActiveGalleryFromMobile()"
                  title="Disponível apenas para administradores ou proprietários"
                >
                  <span class="sr-only">Excluir galeria</span>
                  <span class="button__icon" aria-hidden="true">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673A2.25 2.25 0 0 1 15.916 21.75H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                    </svg>
                  </span>
                </button>
              } @else {
                <span class="badge badge--mono badge--muted">Somente visualização</span>
              }
            </div>
          </header>
          <div class="mobile-shell__content mobile-shell__content--detail">
            <div class="stack stack--tight">
              <h2 class="section-title">{{ activeGallery()?.name ?? 'Galeria' }}</h2>
              @if (activeGallery()?.description) {
                <p class="section-description">{{ activeGallery()?.description }}</p>
              }
              <div class="meta-list">
                @if (activeGallery()?.createdAt) {
                  <span>{{ activeGallery()?.createdAt }}</span>
                }
                <span>{{ images().length }} fotos</span>
              </div>
            </div>
            @if (images().length === 0) {
              <div class="empty-state empty-state--spaced">
                <svg class="empty-state__icon empty-state__icon--sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="0.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
                </svg>
                <h3 class="empty-state__title">Esta galeria está vazia</h3>
                @if (canCaptureInSelectedGallery()) {
                  <p class="empty-state__text">Capture novas imagens para começar seu diário.</p>
                } @else {
                  <p class="empty-state__text">Nenhuma foto foi enviada para esta galeria.</p>
                }
              </div>
            } @else {
              <div class="mobile-gallery-collection gallery-mosaic gallery-mosaic--dense">
                @for (image of images(); track trackMobileImage($index, image); let index = $index) {
                  <button
                    type="button"
                    class="photo-mosaic__item"
                    (click)="onMobilePhotoClick($event, image, index)">
                    <img
                      [src]="image"
                      loading="lazy"
                      class="photo-mosaic__image"
                      alt="Imagem da galeria">
                    <span
                      class="photo-mosaic__border"
                      
                    ></span>
                  </button>
                }
              </div>
            }
          </div>
        </div>
      }
    }
  } @else {
    @if (currentView() === 'galleries') {
      @if (galleryService.galleries().length === 0) {
        <!-- Empty state for galleries -->
        <div class="empty-overlay">
          <svg class="empty-state__icon empty-state__icon--sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="0.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
          </svg>
          <h2 class="empty-overlay__title">Nenhuma galeria criada</h2>
          @if (canCreateGalleries()) {
            <p class="empty-overlay__text">Clique com o botão direito para criar uma nova galeria.</p>
            <div class="empty-overlay__actions">
              <p class="empty-overlay__note">Como tirar uma foto:</p>
              <div class="flow">
                <button
                  data-cursor-pointer
                  (click)="openGalleryCreationDialog(); $event.stopPropagation();"
                  class="button button--primary"
                >
                  Nova Galeria
                </button>
              </div>
            </div>
          } @else {
            <p class="empty-overlay__text">Aguarde o administrador publicar novas galerias.</p>
          }
        </div>
      } @else {
        <!-- Gallery List Canvas -->
        <div class="absolute gallery-canvas">
          <div #canvasWrapper class="canvas-wrapper">
            @for (item of visibleItems(); track trackById($index, item)) {
              @if (item.type === 'gallery') {
                <div
                  class="gallery-card"
                  [class.gallery-card--light]="themeService.isLight()"
                  [class.is-disabled]="!isInteractionEnabled()"
                  [class.is-interactive]="isInteractionEnabled()"
                  [style.width.px]="item.width"
                  [style.height.px]="item.height"
                  [style.left.px]="item.x"
                  [style.top.px]="item.y"
                  [attr.data-cursor-pointer]="isInteractionEnabled() ? '' : null"
                  (click)="selectGallery(item.id)"
                  (mouseenter)="onGalleryHoverStart(item.id, item.previewKey)"
                  (mouseleave)="onGalleryHoverEnd(item.previewKey)"
                  (contextmenu)="onGalleryRightClick($event, item.id)"
                >
                  <div class="gallery-card__media">
                    <img [src]="galleryPreviewImages()[item.previewKey] ?? item.thumbnailUrl"
                         class="gallery-card__image"
                         (load)="$event.target.classList.add('is-visible')"
                         alt="Capa da Galeria: {{ item.name }}">
                    <div
                      class="gallery-card__overlay"
                      [class.gallery-card__overlay--dark]="themeService.isDark()"
                      [class.gallery-card__overlay--light]="themeService.isLight()"
                    ></div>
                  </div>
                  <span class="gallery-card__badge">
                    {{ item.creationOrder }}
                  </span>
                  <div class="gallery-card__meta stack stack--tight">
                    <div class="meta-label">{{ item.createdAt }}</div>
                    <div class="meta-title">{{ item.name }}</div>
                  </div>
                </div>
              }
            }
          </div>
        </div>
      }
    } @else {
      <!-- Photo Grid Canvas -->
      @if (images().length === 0) {
        <!-- Empty state for photos in a gallery -->
        <div class="empty-overlay empty-overlay--interactive">
          <svg class="empty-state__icon empty-state__icon--sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="0.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
          </svg>
          <h2 class="empty-overlay__title">Esta galeria está vazia</h2>
          @if (canCaptureInSelectedGallery()) {
            <p class="empty-overlay__text">Clique com o botão direito para adicionar fotos.</p>
            <div class="empty-overlay__actions">
              <p class="empty-overlay__note">Como tirar uma foto:</p>
              <div class="flow">
                <button
                  data-cursor-pointer
                  (click)="openWebcamCapture(); $event.stopPropagation();"
                  class="button button--primary"
                  [disabled]="!canUploadToGallery()"
                  title="Apenas administradores ou proprietários podem capturar nesta galeria"
                >
                  Usar Câmera
                </button>
                <button
                  data-cursor-pointer
                  (click)="handleSpacebar($event)"
                  class="button button--primary"
                  [disabled]="!canUploadToGallery()"
                  title="Apenas administradores ou proprietários podem capturar nesta galeria"
                >
                  Atalho: Espaço
                </button>
              </div>
            </div>
          } @else {
            <p class="empty-overlay__text">Nenhuma foto disponível nesta galeria.</p>
          }
        </div>
      }
      <div class="absolute gallery-canvas">
        <div #canvasWrapper class="canvas-wrapper">
          @for (item of visibleItems(); track trackById($index, item)) {
            @if (item.type === 'photo') {
              <div
                class="photo-card"
                [class.photo-card--light]="themeService.isLight()"
                [class.is-disabled]="!isInteractionEnabled()"
                [class.is-interactive]="isInteractionEnabled()"
                [style.width.px]="item.width"
                [style.height.px]="item.height"
                [style.left.px]="item.x"
                [style.top.px]="item.y"
                [attr.data-cursor-pointer]="isInteractionEnabled() ? '' : null"
                (click)="onImageClick($event, item)"
                (contextmenu)="onPhotoRightClick($event, item.url)"
              >
                <div class="photo-card__media">
                  <img [src]="item.url"
                       class="photo-card__image"
                       (load)="$event.target.classList.add('is-visible')"
                       alt="Imagem da galeria capturada pela webcam">
                  <div
                    class="photo-card__overlay"
                    [class.photo-card__overlay--dark]="themeService.isDark()"
                    [class.photo-card__overlay--light]="themeService.isLight()"
                  ></div>
                </div>
                <span class="photo-card__badge">
                  {{ item.creationOrder }}
                </span>
              </div>
            }
          }
        </div>
      </div>
    }

    <!-- Relógio e Data -->
    <div class="clock">
      {{ currentTime() }}
    </div>
    <div class="date-indicator">
      {{ currentDate() }}
    </div>

    @if (currentView() === 'photos' && !isIdle()) {
      <!-- Botão Voltar para Galerias -->
      <button (click)="backToGalleries()"
              data-cursor-pointer
              class="app-shell__back-button button button--icon"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon--md" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
      </button>
    }
  }

  @if (isAutoNavigationActive()) {
    <div
      class="auto-navigation-shield"
      aria-hidden="true"
      data-auto-navigation-shield
    ></div>
  }

  <!-- Overlay para o modo de visualização expandida -->
  <div
    class="screen-overlay"
    [class.is-visible]="!!expandedItem()"
    [class.is-hidden]="!expandedItem()"
    data-cursor-pointer
    (click)="closeExpandedItem()"
  ></div>

  <!-- Elemento para a imagem expandida, renderizado condicionalmente -->
  @if (expandedItem(); as item) {
    <div #expandedItemElement
      class="screen-overlay__media"
      style="transform: translate(-50%, -50%); will-change: width, height, transform;">
      <img [src]="item.url" class="screen-overlay__image" alt="Imagem expandida">
      @if (isMobileLayout() && canManageSelectedGallery()) {
        <button
          type="button"
          class="screen-overlay__action button button--icon"
          aria-label="Excluir foto"
          data-cursor-pointer
          (click)="deleteExpandedPhoto($event)"
          title="Disponível apenas para administradores ou proprietários"
        >
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="icon icon--sm">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 9.75h4.5m-4.5 3h4.5M10.5 6h3A1.5 1.5 0 0 1 15 7.5v.75h3.75M6 8.25h12M9 6.75h-.75A1.5 1.5 0 0 0 6.75 8.25v9A1.5 1.5 0 0 0 8.25 18.75h7.5A1.5 1.5 0 0 0 17.25 17.25v-9a1.5 1.5 0 0 0-1.5-1.5H15" />
          </svg>
        </button>
      }
      @if (isMobileLayout()) {
        <div class="screen-overlay__gradient screen-overlay__gradient--left"></div>
        <div class="screen-overlay__gradient screen-overlay__gradient--right"></div>
      }
    </div>
  }
</div>

<!-- Contador de galerias/fotos no canto superior esquerdo -->
<div class="counter">
  @if (currentView() === 'galleries') {
    {{ galleryCounterLabel() }} {{ galleryCount() }}
  } @else {
    {{ photoCounterLabel() }} {{ photoCount() }}
  }
</div>

@if (autoNavigationOverlayVisible()) {
  <div class="auto-navigation-overlay">
    <div
      class="auto-navigation-card"
      
    >
      @if (autoNavigationCountdown() !== null) {
        <p class="auto-navigation-card__eyebrow">
          Navegação automática começa em
        </p>
        <p class="auto-navigation-card__countdown">
          {{ autoNavigationCountdown() }}s
        </p>
      }
      <p class="auto-navigation-card__description">
        Pressione <span class="font-semibold">P</span> ou use o menu de contexto (botão direito) para parar a navegação automática.
      </p>
    </div>
  </div>
}

<!-- Componentes de UI flutuantes -->
@if (isLoginDialogVisible()) {
  <div class="login-dialog" (click)="closeLoginDialog()" data-cursor-pointer>
    <div
      class="login-dialog__card"
      (click)="$event.stopPropagation()">
      <div class="login-dialog__header">
        <div class="stack stack--tight">
          <h2 class="login-dialog__title">Entrar na sua conta</h2>
          <p class="login-dialog__description">Use seu email e senha para acessar suas galerias.</p>
        </div>
        <button
          type="button"
          data-cursor-pointer
          class="button-reset"
          [class.opacity-50]="isLoginInProgress()"
          [disabled]="isLoginInProgress()"
          (click)="closeLoginDialog()">
          &times;
        </button>
      </div>

      @if (loginError()) {
        <div class="alert alert--danger">
          {{ loginError() }}
        </div>
      }

      <form (submit)="submitLogin(); $event.preventDefault();" class="stack">
        <div class="form-field">
          <label class="form-field__label">Email</label>
          <input
            type="email"
            autocomplete="email"
            class="form-field__input"
            [value]="loginEmail()"
            (input)="loginEmail.set($any($event.target).value)"
            [disabled]="isLoginInProgress()"
            required>
        </div>

        <div class="form-field">
          <label class="form-field__label">Senha</label>
          <div class="form-field__input-wrapper">
            <input
              [type]="loginPasswordVisible() ? 'text' : 'password'"
              autocomplete="current-password"
              class="form-field__input form-field__input--with-button"
              [value]="loginPassword()"
              (input)="loginPassword.set($any($event.target).value)"
              [disabled]="isLoginInProgress()"
              required>
            <button
              type="button"
              class="form-field__toggle-button"
              [attr.aria-label]="loginPasswordVisible() ? 'Ocultar senha' : 'Mostrar senha'"
              (click)="toggleLoginPasswordVisibility()"
              tabindex="-1">
              @if (loginPasswordVisible()) {
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="icon icon--sm">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 0 0 1.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.451 10.451 0 0 1 12 4.5c4.756 0 8.773 3.162 10.065 7.498a10.522 10.522 0 0 1-4.293 5.774M6.228 6.228 3 3m3.228 3.228 3.65 3.65m7.894 7.894L21 21m-3.228-3.228-3.65-3.65m0 0a3 3 0 1 0-4.243-4.243m4.242 4.242L9.88 9.88" />
                </svg>
              } @else {
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="icon icon--sm">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" />
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                </svg>
              }
            </button>
          </div>
        </div>

        <div class="stack stack--tight">
          <button
            type="submit"
            data-cursor-pointer
            class="button button--primary button--block"
            [disabled]="isLoginInProgress()">
            @if (isLoginInProgress()) { Entrando... } @else { Entrar }
          </button>
          <p class="form-hint">Acesse para capturar fotos e gerenciar suas galerias.</p>
        </div>
      </form>
    </div>
  </div>
}

@if (isSignUpDialogVisible()) {
  <div class="login-dialog" (click)="closeSignUpDialog()" data-cursor-pointer>
    <div
      class="login-dialog__card"
      (click)="$event.stopPropagation()">
      <div class="login-dialog__header">
        <div class="stack stack--tight">
          <h2 class="login-dialog__title">Criar conta</h2>
          <p class="login-dialog__description">Cadastre-se para capturar fotos e gerenciar suas galerias.</p>
        </div>
        <button
          type="button"
          data-cursor-pointer
          class="button-reset"
          [class.opacity-50]="isSignUpInProgress()"
          [disabled]="isSignUpInProgress()"
          (click)="closeSignUpDialog()">
          &times;
        </button>
      </div>

      @if (signUpError()) {
        <div class="alert alert--danger">
          {{ signUpError() }}
        </div>
      }

      <form (submit)="submitSignUp(); $event.preventDefault();" class="stack">
        <div class="form-field">
          <label class="form-field__label">Email</label>
          <input
            type="email"
            autocomplete="email"
            class="form-field__input"
            [value]="signUpEmail()"
            (input)="signUpEmail.set($any($event.target).value)"
            [disabled]="isSignUpInProgress()"
            required>
        </div>

        <div class="form-field">
          <label class="form-field__label">Senha</label>
          <div class="form-field__input-wrapper">
            <input
              [type]="signUpPasswordVisible() ? 'text' : 'password'"
              autocomplete="new-password"
              class="form-field__input form-field__input--with-button"
              [value]="signUpPassword()"
              (input)="signUpPassword.set($any($event.target).value)"
              [disabled]="isSignUpInProgress()"
              required>
            <button
              type="button"
              class="form-field__toggle-button"
              [attr.aria-label]="signUpPasswordVisible() ? 'Ocultar senha' : 'Mostrar senha'"
              (click)="toggleSignUpPasswordVisibility()"
              tabindex="-1">
              @if (signUpPasswordVisible()) {
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="icon icon--sm">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 0 0 1.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.451 10.451 0 0 1 12 4.5c4.756 0 8.773 3.162 10.065 7.498a10.522 10.522 0 0 1-4.293 5.774M6.228 6.228 3 3m3.228 3.228 3.65 3.65m7.894 7.894L21 21m-3.228-3.228-3.65-3.65m0 0a3 3 0 1 0-4.243-4.243m4.242 4.242L9.88 9.88" />
                </svg>
              } @else {
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="icon icon--sm">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" />
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                </svg>
              }
            </button>
          </div>
        </div>

        <div class="form-field">
          <label class="form-field__label">Confirmar senha</label>
          <div class="form-field__input-wrapper">
            <input
              [type]="signUpConfirmPasswordVisible() ? 'text' : 'password'"
              autocomplete="new-password"
              class="form-field__input form-field__input--with-button"
              [value]="signUpConfirmPassword()"
              (input)="signUpConfirmPassword.set($any($event.target).value)"
              [disabled]="isSignUpInProgress()"
              required>
            <button
              type="button"
              class="form-field__toggle-button"
              [attr.aria-label]="signUpConfirmPasswordVisible() ? 'Ocultar senha' : 'Mostrar senha'"
              (click)="toggleSignUpConfirmPasswordVisibility()"
              tabindex="-1">
              @if (signUpConfirmPasswordVisible()) {
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="icon icon--sm">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 0 0 1.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.451 10.451 0 0 1 12 4.5c4.756 0 8.773 3.162 10.065 7.498a10.522 10.522 0 0 1-4.293 5.774M6.228 6.228 3 3m3.228 3.228 3.65 3.65m7.894 7.894L21 21m-3.228-3.228-3.65-3.65m0 0a3 3 0 1 0-4.243-4.243m4.242 4.242L9.88 9.88" />
                </svg>
              } @else {
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="icon icon--sm">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" />
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                </svg>
              }
            </button>
          </div>
        </div>

        <div class="stack stack--tight">
          <button
            type="submit"
            data-cursor-pointer
            class="button button--primary button--block"
            [disabled]="isSignUpInProgress()">
            @if (isSignUpInProgress()) { Criando conta... } @else { Criar conta }
          </button>
          <p class="form-hint">Você terá acesso imediato e poderá criar sua galeria.</p>
        </div>

        <p class="form-hint">
          Já tem uma conta?
          <button
            type="button"
            class="button-reset"
            data-cursor-pointer
            [disabled]="isSignUpInProgress()"
            (click)="openLoginFromSignUpDialog()">
            Entrar
          </button>
        </p>
      </form>
    </div>
  </div>
}

@if (isSignUpSuccessDialogVisible()) {
  <div class="login-dialog" (click)="closeSignUpSuccessDialog()" data-cursor-pointer>
    <div
      class="login-dialog__card"
      (click)="$event.stopPropagation()">
      <div class="login-dialog__header">
        <div class="stack stack--tight">
          <div class="login-dialog__success-icon">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="icon icon--sm">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75 9 17.25 19.5 6.75" />
            </svg>
          </div>
          <h2 class="login-dialog__title">Conta criada com sucesso</h2>
          <p class="login-dialog__description">
            Enviamos um email para {{ signUpSuccessEmail() ?? 'sua caixa de entrada' }}. Confirme o endereço para habilitar o acesso.
          </p>
        </div>
        <button
          type="button"
          data-cursor-pointer
          class="button-reset"
          (click)="closeSignUpSuccessDialog()">
          &times;
        </button>
      </div>

      <div class="stack">
        <div class="alert alert--success">
          Abra o link de confirmação enviado para concluir o cadastro. Depois, volte aqui e faça login para liberar as ferramentas.
        </div>
        <p class="form-hint">Se não encontrar, verifique também a pasta de spam ou promoções.</p>

        <div class="stack stack--tight">
          <button
            type="button"
            data-cursor-pointer
            class="button button--primary button--block"
            (click)="openLoginFromSignUpSuccess()">
            Abrir tela de login
          </button>
          <button
            type="button"
            data-cursor-pointer
            class="button button--ghost button--block"
            (click)="closeSignUpSuccessDialog()">
            Continuar explorando
          </button>
        </div>
      </div>
    </div>
  </div>
}

@if (contextMenu().visible) {
  <app-context-menu
    [x]="contextMenu().x"
    [y]="contextMenu().y"
    [isFullscreen]="isFullscreen()"
    [groups]="contextMenu().groups"
    [themeMode]="themeService.theme()"
    [isAutoNavigationActive]="isAutoNavigationActive()"
    [autoNavigationCountdown]="autoNavigationCountdown()"
    [canEditGallery]="canEditSelectedGallery()"
    [canUploadToGallery]="canUploadToGallery()"
    [canDeletePhoto]="canDeletePhoto()"
    (close)="closeContextMenu()"
    (capture)="openWebcamCapture()"
    (toggleFullscreen)="toggleFullscreen()"
    (toggleTheme)="toggleThemeMode()"
    (togglePlayback)="toggleAutoNavigation()"
    (createGallery)="openGalleryCreationDialog()"
    (editGallery)="editGalleryContextMenu()"
    (deleteGallery)="deleteGalleryContextMenu()"
    (deletePhoto)="deletePhotoContextMenu()"
    (info)="toggleInfoDialog()">
  </app-context-menu>
}

@if (isWebcamVisible() && canUseCaptureDialog()) {
  <div class="overlay-panel" (click)="isWebcamVisible.set(false)" data-cursor-pointer>
    <app-webcam-capture
      #desktopCapture
      [captureAllowed]="desktopCaptureAllowed()"
      (prepareCapture)="prepareDesktopCapture()"
      (galleryChange)="onDesktopGalleryChange($event)"
      (capture)="onCaptureComplete($event)"
      (close)="isWebcamVisible.set(false)">
      <ng-container gallerySelection>
        <ng-container *ngTemplateOutlet="captureGallerySelection; context: { captureComponent: desktopCapture }"></ng-container>
      </ng-container>
    </app-webcam-capture>
  </div>
}

@if (isGalleryEditorVisible() && canManageSelectedGallery()) {
  <app-gallery-editor
    [gallery]="editingGallery()"
    (close)="isGalleryEditorVisible.set(false); editingGallery.set(null)"
    (save)="handleGallerySave($event)"
    (delete)="handleGalleryDelete($event)">
  </app-gallery-editor>
}

@if (isGalleryCreationDialogVisible() && canCreateGalleries()) {
  <app-gallery-creation-dialog
    (close)="isGalleryCreationDialogVisible.set(false)"
    (save)="handleGalleryCreate($event)">
  </app-gallery-creation-dialog>
}

@if (isSettingsDialogVisible()) {
  <app-settings-dialog
    [isDeleting]="isDeleteAccountInProgress()"
    [error]="deleteAccountError()"
    (close)="closeSettingsDialog()"
    (confirmDelete)="confirmAccountDeletion()">
  </app-settings-dialog>
}

@if (isInfoDialogVisible()) {
  <app-info-dialog
    (close)="isInfoDialogVisible.set(false)">
  </app-info-dialog>
}
</div>
