<!-- Container principal da galeria com listeners para interação -->
<div 
  class="relative w-screen h-screen overflow-hidden select-none grayscale"
  [class.cursor-grab]="canDrag() && !isDragging()"
  [class.cursor-grabbing]="isDragging()"
  (mousedown)="onMouseDown($event)"
  (contextmenu)="onRightClick($event)">

  @if (images().length === 0) {
    <!-- Tela de boas-vindas para estado vazio -->
    <div class="fixed inset-0 flex flex-col items-center justify-center text-center p-4 z-10 pointer-events-none">
      <svg class="w-12 h-12 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
      </svg>
      <h2 class="mt-4 text-xl font-medium text-gray-400 tracking-wider">Sua galeria está vazia</h2>
      <p class="mt-1 text-sm text-gray-500 tracking-wider">Clique com o botão direito para começar.</p>
    </div>
  } @else {
    <!-- O "canvas" é a camada que se move com o arraste -->
    <div #canvas class="absolute will-change-transform">
      @for (item of visibleItems(); track trackById(index, item)) {
        <div 
          class="item group absolute overflow-hidden bg-[#1a1a1a] rounded-lg"
          [style.width.px]="item.width"
          [style.height.px]="item.height"
          [style.left.px]="item.x"
          [style.top.px]="item.y"
          [class.cursor-pointer]="canDrag()"
          (click)="onImageClick($event, item)">
            <div class="item-image-container relative w-full h-full overflow-hidden">
              <img [src]="item.url"
                   class="w-full h-full object-cover pointer-events-none transition-opacity duration-400 opacity-0"
                   (load)="$event.target.classList.add('opacity-100')"
                   [class.group-hover:scale-105]="canDrag()"
                   alt="Imagem da galeria capturada pela webcam">
              <div class="absolute inset-0 pointer-events-none shadow-[inset_0_0_40px_20px_rgba(0,0,0,0.8)] z-10"></div>
            </div>
            <!-- Botão de Curtir (Like) -->
            <button (click)="onLikeClicked($event, item)" 
              class="absolute top-2 right-2 z-20 p-2 bg-black/40 rounded-full text-white opacity-0 group-hover:opacity-100 transition-all duration-300 hover:text-red-500 hover:bg-black/60 focus:outline-none">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />
              </svg>
            </button>
        </div>
      }
    </div>

    <!-- Overlay para o modo de visualização expandida -->
    <div 
      class="overlay fixed inset-0 bg-black/90 pointer-events-none transition-opacity duration-500 z-[9999]"
      [class.opacity-100]="!!expandedItem()"
      [class.opacity-0]="!expandedItem()"
      [class.pointer-events-auto]="!!expandedItem()"
      (click)="closeExpandedItem()">
    </div>

    <!-- Elemento para a imagem expandida, renderizado condicionalmente -->
    @if (expandedItem(); as item) {
      <div #expandedItemElement 
        class="fixed z-[10000] top-1/2 left-1/2 bg-black overflow-hidden rounded-lg flex items-center justify-center shadow-2xl"
        style="transform: translate(-50%, -50%); will-change: width, height, transform;">
        <img [src]="item.url" class="w-full h-full object-contain pointer-events-none" alt="Imagem expandida">
      </div>
    }
  }

</div>

<!-- Componentes de UI flutuantes -->
@if (contextMenu().visible) {
  <app-context-menu 
    [x]="contextMenu().x" 
    [y]="contextMenu().y"
    [isFullscreen]="isFullscreen()"
    (close)="closeContextMenu()" 
    (capture)="openWebcamCapture()"
    (toggleFullscreen)="toggleFullscreen()">
  </app-context-menu>
}

@if (isWebcamVisible()) {
  <div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50" (click)="isWebcamVisible.set(false)">
    <app-webcam-capture (close)="isWebcamVisible.set(false)"></app-webcam-capture>
  </div>
}
